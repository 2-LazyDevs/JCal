<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JCal - Your go to calculator</title>
  <meta name="description" content="A simple yet powerful calculator">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="2dny6BEuGs3nwyVuXJACX5Zge_uEgRez_PqKc3uXoC4" />
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.2/lib/browser/math.js"></script>
  <style>
    :root {
      --main-bg: linear-gradient(135deg, #6e8efb, #a777e3);
      --header-bg: linear-gradient(90deg, #6e8efb 0%, #a777e3 50%, #fd9536 100%);
      --accent: #7367f0;
      --operator-bg: linear-gradient(115deg, #fd9536 78%, #fdcf36 140%);
      --function-bg: linear-gradient(120deg, #42e695 60%, #3bb2b8 140%);
      --equal-bg: linear-gradient(120deg, #7367f0 70%, #a777e3 120%);
      --btn-bg: linear-gradient(115deg, #292929 70%, #313131 130%);
      --display-bg: linear-gradient(95deg, #191919 75%, #7367f04d 100%);
      --calc-bg: rgba(34,34,34,0.98);
      --calc-card-radius: 32px;
      --panel-bg: rgba(255,255,255,0.96);
      --panel-radius: 17px;
      --footer-bg: linear-gradient(90deg, #6e8efb 0%, #a777e3 50%, #fd9536 100%);
      --text-color: #fff;
      --history-result-bg: linear-gradient(110deg, #7367f0 70%, #a777e3 130%);
      --memory-bg: #fff4;
    }
    [data-theme='light'] {
      --main-bg: linear-gradient(135deg,#e0ecff,#fbeaff);
      --header-bg: linear-gradient(90deg, #fbeaff 0%, #a777e3 50%, #fd9536 100%);
      --calc-bg: #f6f9ff;
      --display-bg: linear-gradient(95deg, #fff 70%, #ddd 100%);
      --btn-bg: linear-gradient(115deg, #fff 70%, #e6e6fa 130%);
      --panel-bg: #fff;
      --text-color: #2b2b2b;
      --history-result-bg: linear-gradient(110deg, #a777e3 70%, #7367f0 130%);
      --memory-bg: #e0ecff;
    }
    [data-theme='dark'] {
      --main-bg: linear-gradient(135deg, #1b1938, #3a2a71);
      --header-bg: linear-gradient(90deg, #222 0%, #444 60%, #7367f0 100%);
      --calc-bg: #282828;
      --display-bg: linear-gradient(95deg, #111 70%, #292929 100%);
      --btn-bg: linear-gradient(115deg, #222 70%, #363636 130%);
      --panel-bg: #23223b;
      --text-color: #f2f2f2;
      --history-result-bg: linear-gradient(110deg, #7367f0 70%, #a777e3 130%);
      --memory-bg: #444a;
    }
    [data-theme='neon'] {
      --main-bg: linear-gradient(135deg, #0f2027, #2c5364);
      --header-bg: linear-gradient(90deg, #12c2e9 0%, #c471f5 50%, #fa709a 100%);
      --calc-bg: #1a0033;
      --display-bg: linear-gradient(95deg, #1a0033 80%, #fa709a80 100%);
      --btn-bg: linear-gradient(115deg, #11002a 70%, #3a0ca3 130%);
      --panel-bg: #210048ee;
      --text-color: #fff;
      --history-result-bg: linear-gradient(110deg, #12c2e9 60%, #fa709a 140%);
      --memory-bg: #fa709a55;
    }
    body {
      background: var(--main-bg);
      color: var(--text-color);
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s;
    }
    .jcal-header {
      width: 100vw;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 70px;
      background: var(--header-bg);
      box-shadow: 0 4px 18px #7367f022;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      margin-bottom: 0;
      z-index: 10;
      padding: 0 32px;
    }
    .jcal-header-title {
      font-size: 2.1em;
      font-weight: 800;
      letter-spacing: 2.5px;
      background-clip: text;
      -webkit-background-clip: text;
      background: linear-gradient(90deg, #fff 50%, #fd9536 100%);
      -webkit-text-fill-color: transparent;
      text-shadow: 0 1.5px 8px #6e8efb60, 0 1px 12px #a777e340;
      margin: 0;
      padding: 0 12px;
      user-select: none;
    }
    #theme-select {
      border-radius: 10px;
      padding: 5px 15px;
      font-size: 1em;
      border: none;
      margin-left: 12px;
      outline: none;
      background: #fff8;
      color: #3a2a71;
      font-weight: 600;
    }
    #instances {
      display: flex;
      align-items: center;
      padding: 12px 0 0 0;
      width: 700px;
      max-width: 98vw;
      gap: 14px;
      margin-top: 10px;
    }
    #instances button {
      border-radius: 8px;
      border: none;
      background: var(--header-bg);
      color: #fff;
      font-weight: bold;
      margin-right: 8px;
      padding: 7px 17px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #7367f033;
      transition: background 0.18s, box-shadow 0.14s;
    }
    #instance-tabs span {
      display: inline-flex;
      align-items: center;
      margin-right: 6px;
      margin-bottom: 2px;
    }
    #instance-tabs button {
      background: #fff3;
      color: var(--accent);
      font-weight: bold;
      border: 2px solid #7367f0cc;
      transition: background 0.18s, color 0.12s;
      margin-right: 2px;
      margin-bottom: 0;
      padding: 7px 13px;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
    }
    #instance-tabs button.active {
      background: var(--accent);
      color: #fff;
    }
    #instance-tabs .delete-instance-btn {
      background: none;
      color: #e74c3c;
      font-size: 1.1em;
      border: none;
      padding: 0 4px;
      margin-left: 2px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.14s;
    }
    #instance-tabs .delete-instance-btn:hover {
      background: #e74c3c22;
    }
    .container {
      display: flex;
      gap: 26px;
      align-items: flex-start;
      width: 700px;
      max-width: 98vw;
      margin-top: 24px;
      margin-bottom: 40px;
      position: relative;
      z-index: 1;
    }
    .calculator {
      background: var(--calc-bg);
      border-radius: var(--calc-card-radius);
      box-shadow: 0 16px 60px #0005, 0 0px 1.5px #fff3 inset;
      padding: 30px 28px;
      width: 410px;
      max-width: 98vw;
      backdrop-filter: blur(3.5px);
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .display {
      background: var(--display-bg);
      color: var(--text-color);
      font-size: 2.25em;
      border-radius: 14px;
      margin-bottom: 22px;
      padding: 18px 14px;
      text-align: right;
      min-height: 50px;
      letter-spacing: 2px;
      overflow-x: auto;
      box-shadow: 0 8px 28px #7367f022, 0 1.5px 0 #fff2 inset;
      border: 2.5px solid #7367f044;
      word-break: break-all;
      width: 100%;
      transition: box-shadow .18s, border .18s;
    }
    .memory-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--memory-bg);
      padding: 7px 8px 7px 8px;
      border-radius: 9px;
      margin-bottom: 12px;
      width: 100%;
      box-sizing: border-box;
      gap: 8px;
    }
    .memory-row button {
      background: var(--btn-bg);
      color: var(--text-color);
      border: 2px solid #7367f0aa;
      border-radius: 7px;
      font-weight: 700;
      font-size: 1.01em;
      padding: 6px 12px;
      cursor: pointer;
      margin: 0 2px;
      transition: background 0.18s, color 0.14s, border 0.12s;
    }
    .memory-value {
      font-weight: bold;
      font-size: 1.07em;
      color: var(--accent);
      margin-left: 10px;
      margin-right: 0;
      min-width: 48px;
      text-align: right;
      letter-spacing: 1px;
    }
    .keypad-wrapper {
      display: flex;
      width: 100%;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 0;
    }
    .numpad, .opspad {
      display: grid;
      gap: 11px;
      border-radius: 18px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 2px 16px #7367f018;
      padding: 16px 10px;
    }
    .numpad {
      grid-template-columns: repeat(3, 62px);
      grid-template-rows: repeat(5, 48px);
      justify-items: stretch;
      align-items: stretch;
    }
    .opspad {
      grid-template-columns: 62px;
      grid-template-rows: repeat(8, 48px);
      justify-items: stretch;
      align-items: stretch;
      margin-left: 5px;
    }
    .numpad button, .opspad button {
      width: 100%;
      height: 100%;
    }
    .function, .operator, .clear, .equal, .back {
      font-weight: bold;
    }
    .function { background: var(--function-bg); color: #222; border: 2px solid #42e69599;}
    .function:active { background: linear-gradient(120deg, #3bb2b8 60%, #42e695 140%);}
    .operator { background: var(--operator-bg); color: #fff; border: 2px solid #fdcf3699;}
    .operator:active { background: linear-gradient(115deg, #f57900 75%, #fd9536 120%);}
    .equal { background: var(--equal-bg); color: #fff; border: 2px solid #a777e3a8;}
    .equal:active { background: linear-gradient(120deg, #5447c6 70%, #a777e3 120%);}
    .clear { background: linear-gradient(120deg, #e74c3c 70%, #fd9536 120%); color: #fff; border: 2px solid #e74c3c99;}
    .clear:active { background: linear-gradient(120deg, #c0392b 75%, #fd9536 120%);}
    .back { background: linear-gradient(120deg, #888 70%, #444 130%); color: #fff; border: 2px solid #8884;}
    .back:active { background: linear-gradient(120deg, #555 70%, #222 130%);}
    .numpad button:hover, .opspad button:hover, .numpad button:focus-visible, .opspad button:focus-visible {
      filter: brightness(1.18) saturate(1.23) drop-shadow(0 0 18px #fff3);
      transform: translateY(-3px) scale(1.06);
      box-shadow: 0 8px 24px #7367f022, 0 0 12px #fff3;
      border-color: #7367f0cc;
      z-index: 2;
    }
    button {
      padding: 0;
      font-size: 1.18em;
      border-radius: 12px;
      transition: background 0.18s, color 0.14s, box-shadow 0.18s, border 0.13s, transform 0.09s;
      border: 2px solid transparent;
      cursor: pointer;
      user-select: none;
      outline: none;
      box-shadow: 0 2px 8px #0002;
      position: relative;
      will-change: transform, box-shadow;
    }
    button .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple-animation 0.44s linear;
      background: radial-gradient(circle, #fff8 45%, transparent 70%);
      pointer-events: none;
      z-index: 10;
    }
    @keyframes ripple-animation {
      to {
        transform: scale(2.6);
        opacity: 0;
      }
    }
    button.pulse {
      animation: btn-pulse 0.17s cubic-bezier(.33,1.21,.44,1.02);
    }
    @keyframes btn-pulse {
      0%   { box-shadow: 0 0 0 0 #7367f0aa; }
      70%  { box-shadow: 0 0 0 8px #7367f033; }
      100% { box-shadow: 0 0 0 0 #7367f000; }
    }
    .footer {
      width: 100vw;
      text-align: center;
      padding: 16px 0 12px 0;
      font-size: 1.12em;
      font-weight: 500;
      letter-spacing: 1.1px;
      color: #fff;
      margin-top: 8px;
      background: var(--footer-bg);
      box-shadow: 0 -4px 18px #7367f022;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      user-select: none;
      position: relative;
      z-index: 11;
      opacity: 0.97;
      margin-bottom: 0;
    }
    .footer .heart {
      color: #e74c3c;
      font-size: 1.2em;
      padding: 0 2px 0 1px;
      vertical-align: middle;
      animation: heartbeat 1.4s infinite;
      display: inline-block;
    }
    @keyframes heartbeat {
      0%, 100% { transform: scale(1);}
      10% { transform: scale(1.12);}
      24% { transform: scale(1.20);}
      33% { transform: scale(1.10);}
      42% { transform: scale(1.22);}
      48% { transform: scale(1);}
      70% { transform: scale(1);}
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; align-items: center; margin-top: 70px; }
      .calculator { width: 97vw; max-width: 97vw; }
      .keypad-wrapper { flex-direction: column; gap: 10px;}
      .numpad, .opspad { grid-template-columns: repeat(3, 1fr); }
      .opspad { grid-template-columns: repeat(4, 1fr);}
      .history-panel { min-width: 95vw; max-width: 95vw; }
    }
    @media (max-width: 480px) {
      .container { margin-top: 16vw; }
      .jcal-header { height: 56px; font-size: 0.76em; }
      .footer { font-size: 0.90em; }
    }
    /* History panel, history-entry, etc. as in previous code */
    .history-panel {
      background: var(--panel-bg);
      border-radius: var(--panel-radius);
      box-shadow: 0 4px 28px #7367f023, 0 0.5px 0 #fff2 inset;
      padding: 19px 16px 12px 16px;
      min-width: 280px;
      max-width: 320px;
      max-height: 430px;
      font-size: 1.08em;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 2px solid #7367f01a;
      position: relative;
      z-index: 0;
    }
    .history-title {
      font-weight: 700;
      margin-bottom: 14px;
      color: #7367f0;
      text-align: center;
      letter-spacing: 1.2px;
      font-size: 1.11em;
      text-shadow: 0 1px 2px #a777e329;
      opacity: 1;
      user-select: none;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
      overflow-y: auto;
      max-height: 320px;
      padding-right: 2px;
      scrollbar-width: thin;
      scrollbar-color: #7367f077 #f5f5fa;
    }
    .history-list::-webkit-scrollbar {
      width: 7px;
    }
    .history-list::-webkit-scrollbar-thumb {
      background: #7367f055;
      border-radius: 8px;
    }
    .history-list::-webkit-scrollbar-track {
      background: #f5f5fa;
    }
    .history-entry {
      position: relative;
      background: linear-gradient(94deg, #f5f5fa 70%, #e2e2fa 130%);
      border-radius: 13px;
      padding: 11px 15px 10px 18px;
      min-height: 54px;
      cursor: pointer;
      transition: background 0.18s, transform 0.18s, box-shadow 0.18s;
      border: 2px solid #7367f01a;
      box-shadow: 0 1.5px 6px #7367f018;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      overflow: visible;
      z-index: 1;
    }
    .history-entry:before {
      content: "";
      display: block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      margin-right: 0px;
      background: linear-gradient(135deg, #7367f0 60%, #a777e3 140%);
      box-shadow: 0 0 8px #a777e344;
      flex-shrink: 0;
      opacity: 0.85;
    }
    .history-entry:hover,
    .history-entry:focus-visible {
      background: linear-gradient(94deg, #e9e7ff 55%, #dcdcf9 130%);
      transform: scale(1.045) translateX(5px);
      box-shadow: 0 2px 12px #7367f045, 0 0 12px #7367f022 inset;
      outline: 2px solid #7367f055;
      border-color: #7367f0bb;
      z-index: 2;
    }
    .history-expression {
      color: #313131;
      font-size: 1.01em;
      letter-spacing: 0.3px;
      font-weight: 500;
      opacity: 0.88;
      margin-right: auto;
      word-break: break-all;
      flex-basis: 55%;
    }
    .history-result {
      color: #fff;
      font-size: 1.18em;
      text-align: right;
      font-weight: bold;
      text-shadow: 0 1.5px 2px #7367f0b2;
      letter-spacing: 1.2px;
      background: var(--history-result-bg);
      border-radius: 8px 16px 16px 8px;
      padding: 3px 15px 3px 13px;
      margin-left: 12px;
      min-width: 60px;
      box-shadow: 0 1.5px 7px #7367f03b;
      border: 1.5px solid #7367f066;
      transition: background 0.18s, box-shadow 0.18s, border 0.18s;
      flex-shrink: 0;
    }
    .history-entry:hover .history-result,
    .history-entry:focus-visible .history-result {
      background: linear-gradient(110deg, #a777e3 60%, #7367f0 140%);
      border-color: #a777e3cc;
    }
    .history-entry-reuse {
      position: absolute;
      right: 42px;
      bottom: 10px;
      font-size: 0.98em;
      color: #a777e3;
      opacity: 0.7;
      pointer-events: none;
      user-select: none;
      font-style: italic;
      letter-spacing: .5px;
      display: none;
    }
    .history-entry:hover .history-entry-reuse,
    .history-entry:focus-visible .history-entry-reuse {
      display: block;
    }
    .history-delete-btn {
      background: none;
      border: none;
      position: absolute;
      right: 9px;
      top: 9px;
      color: #e74c3c;
      font-size: 1.2em;
      cursor: pointer;
      padding: 5px 5px 3px 5px;
      border-radius: 50%;
      opacity: 0.7;
      transition: background 0.15s, color 0.12s, opacity 0.11s;
      z-index: 10;
      outline: none;
      box-shadow: none;
    }
    .history-delete-btn:hover,
    .history-delete-btn:focus-visible {
      background: #fd9536;
      color: #fff;
      opacity: 1;
      outline: 2px solid #e74c3c44;
    }
    .history-empty {
      background: #fcfaff;
      border-radius: 7px;
      cursor: default;
      color: #aaa;
      text-align: center;
      padding: 14px 0;
      font-size: 1em;
      margin: 10px 0;
      user-select: none;
      border: 1.5px dashed #7367f033;
    }
    .history-clear {
      background: linear-gradient(120deg, #e74c3c 70%, #fd9536 120%);
      color: #fff;
      border: none;
      border-radius: 7px;
      margin: 10px auto 0;
      padding: 8px 22px 7px 22px;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 3px 12px #e74c3c26, 0 1.5px 0 #fff2 inset;
      transition: background 0.16s, transform 0.14s, box-shadow 0.16s;
      display: block;
      border: 2px solid #e74c3c55;
    }
    .history-clear:hover,
    .history-clear:focus-visible {
      background: linear-gradient(120deg, #c0392b 75%, #fd9536 120%);
      transform: scale(1.06) translateY(-2px);
      box-shadow: 0 6px 18px #e74c3c34;
      border-color: #fd9536;
    }
  </style>
</head>
<body>
  <div class="jcal-header">
    <div>
      <select id="theme-select">
        <option value="default">Default</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="neon">Neon</option>
      </select>
    </div>
  </div>
  <div id="instances">
    <button onclick="addInstance()">+ New Instance</button>
    <div id="instance-tabs"></div>
  </div>
  <div class="container">
    <div class="calculator" role="region" aria-label="Calculator">
      <div class="display" id="display" aria-live="polite" tabindex="0">0</div>
      <div class="memory-row">
        <button onclick="memoryAdd()">M+</button>
        <button onclick="memorySubtract()">M-</button>
        <button onclick="memoryRecall()">MR</button>
        <button onclick="memoryClear()">MC</button>
        <span class="memory-value" id="memory-value">0</span>
      </div>
      <div class="keypad-wrapper">
        <div class="numpad">
          <button onclick="press('7')">7</button>
          <button onclick="press('8')">8</button>
          <button onclick="press('9')">9</button>
          <button onclick="press('4')">4</button>
          <button onclick="press('5')">5</button>
          <button onclick="press('6')">6</button>
          <button onclick="press('1')">1</button>
          <button onclick="press('2')">2</button>
          <button onclick="press('3')">3</button>
          <button onclick="press('0')">0</button>
          <button onclick="press('.')">.</button>
          <button class="function" onclick="press('pi')" title="Pi">Ï€</button>
          <button class="function" onclick="press('sqrt(')" title="Square Root">âˆš</button>
          <button class="function" onclick="press('sin(')" title="Sine">sin</button>
          <button class="function" onclick="press('cos(')" title="Cosine">cos</button>
          <button class="function" onclick="press('tan(')" title="Tangent">tan</button>
          <button class="function" onclick="press('log(')" title="Logarithm">log</button>
          <button class="function" onclick="press('ln(')" title="Natural Log">ln</button>
          <button class="operator" onclick="press('+')" title="Add">+</button>
          <button class="operator" onclick="press('^')" title="Exponent">^</button>
          <button class="operator" onclick="press('-')" title="Subtract">âˆ’</button>
        </div>
        <div class="opspad">
          <button class="clear" onclick="clearDisplay()" title="Clear">C</button>
          <button class="back" onclick="backspace()" title="Backspace">âŒ«</button>
          <button class="operator" onclick="press('(')" title="Left Parenthesis">(</button>
          <button class="operator" onclick="press(')')" title="Right Parenthesis">)</button>
          <button class="operator" onclick="press('/')" title="Divide">Ã·</button>
          <button class="operator" onclick="press('*')" title="Multiply">Ã—</button>
          <button class="equal" onclick="calculate()" title="Equals">=</button>
        </div>
      </div>
    </div>
    <div class="history-panel" id="history-panel">
      <div class="history-title">History</div>
      <div class="history-list" id="history-list"></div>
      <button class="history-clear" onclick="clearHistory()">Clear History</button>
    </div>
  </div>
  <div class="footer">
    Made with <span class="heart">â™¥</span> 2LazyDevs
  </div>
  <script>
    // THEME
    const themeSelect = document.getElementById('theme-select');
    themeSelect.onchange = (e) => {
      document.body.setAttribute('data-theme', e.target.value);
      localStorage.setItem('theme', e.target.value);
    };
    document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'default');
    themeSelect.value = localStorage.getItem('theme') || 'default';

    // INSTANCE SWITCHER WITH DELETE SUPPORT
    let instances = JSON.parse(localStorage.getItem('instances') || '["Default"]');
    let currentInstance = Number(localStorage.getItem('currentInstance') || 0);
    function addInstance() {
      const name = prompt("Instance name?", "Science");
      if (name) {
        instances.push(name);
        localStorage.setItem('instances', JSON.stringify(instances));
        renderInstanceTabs();
      }
    }
    function renderInstanceTabs() {
      const tabs = document.getElementById('instance-tabs');
      tabs.innerHTML = '';
      instances.forEach((inst, i) => {
        const tab = document.createElement('span');
        tab.style.display = 'inline-flex';
        tab.style.alignItems = 'center';
        const btn = document.createElement('button');
        btn.textContent = inst;
        btn.className = i === currentInstance ? "active" : "";
        btn.onclick = () => {
          currentInstance = i;
          localStorage.setItem('currentInstance', i);
          loadInstance();
          renderInstanceTabs();
        };
        tab.appendChild(btn);

        // Don't allow delete for Default or if only one instance remains
        if (inst !== "Default" && instances.length > 1) {
          const delBtn = document.createElement('button');
          delBtn.textContent = "ðŸ—‘ï¸";
          delBtn.className = "delete-instance-btn";
          delBtn.title = "Delete this instance";
          delBtn.onclick = (e) => {
            e.stopPropagation();
            // Remove instance and its data
            let removed = instances.splice(i, 1);
            localStorage.setItem('instances', JSON.stringify(instances));
            // Remove history/memory from storage
            localStorage.removeItem(`instance${i}_history`);
            localStorage.removeItem(`instance${i}_memory`);
            // Re-index data for remaining instances
            for (let j = i + 1; j <= instances.length; j++) {
              let h = localStorage.getItem(`instance${j}_history`);
              let m = localStorage.getItem(`instance${j}_memory`);
              if (h !== null) {
                localStorage.setItem(`instance${j-1}_history`, h);
                localStorage.removeItem(`instance${j}_history`);
              }
              if (m !== null) {
                localStorage.setItem(`instance${j-1}_memory`, m);
                localStorage.removeItem(`instance${j}_memory`);
              }
            }
            // If current deleted, switch to first
            if (currentInstance === i) {
              currentInstance = 0;
              localStorage.setItem('currentInstance', 0);
            } else if (currentInstance > i) {
              // Adjust index if after deleted
              currentInstance--;
              localStorage.setItem('currentInstance', currentInstance);
            }
            renderInstanceTabs();
            loadInstance();
          };
          tab.appendChild(delBtn);
        }
        tabs.appendChild(tab);
      });
    }
    renderInstanceTabs();

    // CALCULATOR, MEMORY, HISTORY
    let display = document.getElementById('display');
    let historyList = document.getElementById('history-list');
    let memoryValue = document.getElementById('memory-value');
    let expression = '';
    let lastInput = '';
    let history = [];
    let memory = 0;
    function instanceKey(key) {
      return `instance${currentInstance}_${key}`;
    }
    function saveInstance() {
      localStorage.setItem(instanceKey('history'), JSON.stringify(history));
      localStorage.setItem(instanceKey('memory'), memory);
    }
    function loadInstance() {
      history = JSON.parse(localStorage.getItem(instanceKey('history')) || '[]');
      memory = Number(localStorage.getItem(instanceKey('memory')) || 0);
      memoryValue.textContent = memory;
      renderHistory();
    }
    loadInstance();

    // Memory functions
    function memoryAdd() { memory += parseFloat(display.innerText)||0; memoryValue.textContent = memory; saveInstance();}
    function memorySubtract() { memory -= parseFloat(display.innerText)||0; memoryValue.textContent = memory; saveInstance();}
    function memoryRecall() { updateDisplay(memory); }
    function memoryClear() { memory = 0; memoryValue.textContent = memory; saveInstance(); }

    // Button effects
    document.querySelectorAll('.numpad button, .opspad button, .history-clear, .memory-row button').forEach(btn => {
      btn.addEventListener('click', function(e) {
        let oldRipple = btn.querySelector('.ripple');
        if (oldRipple) oldRipple.remove();
        let ripple = document.createElement('span');
        ripple.className = 'ripple';
        let rect = btn.getBoundingClientRect();
        let size = Math.max(rect.width, rect.height);
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
        ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
        btn.appendChild(ripple);
        ripple.addEventListener('animationend', () => ripple.remove());
        btn.classList.remove('pulse');
        void btn.offsetWidth;
        btn.classList.add('pulse');
      });
      btn.addEventListener('keydown', function(e) {
        if ([' ', 'Enter'].includes(e.key)) {
          btn.classList.add('kbd-bounce');
        }
      });
      btn.addEventListener('animationend', function(e) {
        if (e.animationName === 'kbd-bounce') {
          btn.classList.remove('kbd-bounce');
        }
      });
    });
    const style = document.createElement('style');
    style.innerHTML = `
    @keyframes kbd-bounce {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.11); }
      60%  { transform: scale(0.90);}
      100% { transform: scale(1);}
    }
    .kbd-bounce { animation: kbd-bounce 0.16s; }
    `;
    document.head.appendChild(style);

    function updateDisplay(val = expression) {
      display.innerText = val || '0';
    }
    function press(value) {
      if (display.innerText === 'Error') {
        expression = '';
      }
      const operators = ['+', '-', '*', '/', '^'];
      if (operators.includes(value)) {
        if (expression === '' || operators.includes(lastInput) || lastInput === '(') return;
      }
      if (value === '.') {
        const parts = expression.split(/[\+\-\*\/\(\)\^]/);
        if (parts[parts.length - 1].includes('.')) return;
        if (lastInput === '' || operators.includes(lastInput) || lastInput === '(') {
          expression += '0';
        }
      }
      if (value === '(') {
        if (lastInput && (!isNaN(lastInput) || lastInput === ')' || lastInput === 'Ï€')) expression += '*';
      }
      if (value === ')') {
        if ((expression.match(/\(/g) || []).length <= (expression.match(/\)/g) || []).length) return;
        if (operators.includes(lastInput) || lastInput === '(' || lastInput === '') return;
      }
      if (/^(sqrt|sin|cos|tan|log|ln)$/.test(value.replace('(',''))) {
        if (lastInput && (!isNaN(lastInput) || lastInput === ')' || lastInput === 'Ï€')) expression += '*';
      }
      if (value === 'pi') {
        if (lastInput && (!isNaN(lastInput) || lastInput === ')' || lastInput === 'Ï€')) expression += '*';
        value = 'Ï€';
      }
      expression += value;
      lastInput = value.endsWith('(') ? '(' : value.slice(-1);
      updateDisplay();
    }
    // Handle tan(90) and similar cases (odd multiples of 90)
    function isTanSingular(expr) {
      let regex = /tan\s*\(\s*([^\)]+)\s*\)/g;
      let match; while ((match = regex.exec(expr)) !== null) {
        let argStr = match[1];
        try {
          let arg = math.evaluate(argStr);
          if (Math.abs((arg - 90) % 180) < 1e-8) return true;
        } catch {}
      }
      return false;
    }
    function calculate() {
      try {
        if (expression === '') return;
        if ((expression.match(/\(/g) || []).length !== (expression.match(/\)/g) || []).length) {
          display.innerText = 'Error'; expression = ''; return;
        }
        let mathExpr = expression
          .replace(/Ï€/g, 'pi')
          .replace(/Ã·/g, '/')
          .replace(/Ã—/g, '*')
          .replace(/âˆš/g, 'sqrt')
          .replace(/(\d+)\s*([a-zA-Z])/g, '$1*$2')
          .replace(/\^/g, '**');
        mathExpr = mathExpr.replace(/sin\(([^)]+)\)/g, 'sin(deg2rad($1))');
        mathExpr = mathExpr.replace(/cos\(([^)]+)\)/g, 'cos(deg2rad($1))');
        mathExpr = mathExpr.replace(/tan\(([^)]+)\)/g, 'tan(deg2rad($1))');
        math.import({
          deg2rad: function(deg) { return deg * Math.PI / 180; }
        }, {override: true});
        if (isTanSingular(expression)) {
          display.innerText = 'undefined'; expression = ''; lastInput = ''; return;
        }
        let result = math.evaluate(mathExpr);
        if (typeof result === 'number') result = +result.toFixed(10);
        if (result === Infinity || isNaN(result)) {
          display.innerText = 'Error';
        } else {
          display.innerText = result;
          addToHistory(expression, result);
          expression = result.toString();
        }
        lastInput = '';
      } catch {
        display.innerText = 'Error'; expression = ''; lastInput = '';
      }
    }
    function clearDisplay() { expression = ''; lastInput = ''; updateDisplay(); }
    function backspace() {
      if (display.innerText === 'Error' || display.innerText === 'undefined') {
        clearDisplay(); return;
      }
      let funcs = ['sqrt(', 'sin(', 'cos(', 'tan(', 'log(', 'ln('];
      for (let f of funcs) {
        if (expression.endsWith(f)) {
          expression = expression.slice(0, -f.length); lastInput = expression.slice(-1); updateDisplay(); return;
        }
      }
      if (expression.endsWith('Ï€')) {
        expression = expression.slice(0, -1); lastInput = expression.slice(-1); updateDisplay(); return;
      }
      expression = expression.slice(0, -1); lastInput = expression.slice(-1); updateDisplay();
    }
    window.addEventListener('keydown', function(e) {
      if (e.key >= '0' && e.key <= '9') press(e.key);
      else if (['+', '-', '*', '/', '^'].includes(e.key)) press(e.key);
      else if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); calculate(); }
      else if (e.key === '.') press('.');
      else if (e.key === '(') press('(');
      else if (e.key === ')') press(')');
      else if (e.key === 'Backspace') backspace();
      else if (e.key.toLowerCase() === 'c') clearDisplay();
      else if (e.key.toLowerCase() === 's') press('sin(');
      else if (e.key.toLowerCase() === 'q') press('sqrt(');
      else if (e.key.toLowerCase() === 'l') press('log(');
      else if (e.key.toLowerCase() === 'n') press('ln(');
      else if (e.key.toLowerCase() === 'p') press('pi');
      else if (e.key.toLowerCase() === 't') press('tan(');
      else if (e.key.toLowerCase() === 'o') press('cos(');
    });

    function addToHistory(expr, res) {
      if (typeof res === "undefined" || res === "") return;
      history.push({expr, res});
      if (history.length > 50) history.shift();
      saveInstance();
      renderHistory();
    }
    function renderHistory() {
      historyList.innerHTML = "";
      if (!history.length) {
        let emptyNote = document.createElement('div');
        emptyNote.className = 'history-empty';
        emptyNote.innerHTML = 'No history yet';
        historyList.appendChild(emptyNote);
        return;
      }
      history.slice().reverse().forEach(({expr, res}, idx) => {
        let div = document.createElement('div');
        div.className = 'history-entry';
        div.tabIndex = 0;
        div.setAttribute('title', 'Click to reuse');
        div.innerHTML = `
          <span class="history-expression">${expr}</span>
          <span class="history-result">${res}</span>
          <span class="history-entry-reuse">Click to reuse</span>
          <button class="history-delete-btn" title="Delete">&#128465;</button>
        `;
        div.onclick = (e) => {
          if (e.target.classList.contains('history-delete-btn')) return;
          expression = expr;
          lastInput = expr.slice(-1);
          updateDisplay(expr);
          div.animate([
            { background: '#e9e7ff' },
            { background: '#f5f5fa' }
          ], { duration: 260, fill: 'forwards' });
        };
        div.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            div.click();
            e.preventDefault();
          }
        }
        div.querySelector('.history-delete-btn').onclick = (e) => {
          e.stopPropagation();
          let realIdx = history.length - 1 - idx;
          history.splice(realIdx, 1);
          saveInstance();
          renderHistory();
        };
        historyList.appendChild(div);
      });
    }
    function clearHistory() { history = []; saveInstance(); renderHistory(); }
  </script>
</body>
</html>